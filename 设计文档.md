# 项目设计文档：NUAA 文件分类展示网站

更新日期：2025-10-25

目的：为仓库内的学校资料（课程、资源、指南等）提供一个静态/动态混合的网页前端，用于按分类浏览、搜索与查看文件。预计部署在 Vercel，前端使用 Vite + React + TypeScript，后端使用轻量 Node.js（Serverless-friendly），采用自顶向下的 RESTful 设计。

总体约束与假设

- 目标托管：Vercel（静态前端 + Serverless API）。
- 代码风格：TypeScript 优先，尽量添加类型声明与简单测试。
- 数据源：当前仓库目录即为主要文件源，后端负责索引并向前端提供 JSON 接口。
- 文件访问：文件直接托管在仓库（或 Vercel 静态路径），前端由 URL 打开或通过内置预览（如 PDF/Office 在线预览或下载）。
- 初期不做用户认证，只做公开浏览。

小合同（Contract, Inputs/Outputs/Error modes）

- 输入：前端通过 HTTP(S) 请求 REST API 获取分类树、文件列表、单文件元数据与原始文件 URL。
- 输出：JSON 格式的响应（带分页或筛选参数），状态码遵守 HTTP 语义（200, 204, 400, 404, 500）。
- 错误：错误响应包含 { error: string, code?: string }，并返回适当 HTTP 状态码。

功能分解（高层）

1. 后端（索引 + API）
   - 定期或按需扫描仓库目录（或在构建阶段生成索引），生成 JSON 索引文件（例如 index.json）。
   - 提供 RESTful API：分类列表、按分类的文件列表、文件详情、搜索接口、静态文件访问路径。
2. 前端（React + TS + Vite）
   - 基本页面：主页、分类页、文件详情页、搜索结果页、404。
   - 组件：分类侧栏、文件卡片、面包屑导航、分页组件、搜索框。
3. 部署/构建
   - 使用 Vite 构建前端，部署为静态站点。
   - 后端 API 使用 Vercel Serverless Functions（或 Edge Functions）部署，或将索引文件作为静态 JSON 一并部署以减少后端成本。

数据模型（JSON schema 概览）

- Category（分类）
  {
  "id": string, // 唯一标识，例如路径哈希或路径字符串
  "name": string, // 显示名称（最后一级目录名或映射）
  "path": string, // 仓库内相对路径，例如 "课程/C C++语言课程设计"
  "parentId": string|null, // 父分类 id
  "childrenCount": number // 子分类数量（可选）
  }

- FileMeta（文件元数据）
  {
  "id": string, // 唯一标识（基于相对路径）
  "name": string, // 文件名
  "path": string, // 相对路径
  "categoryId": string, // 所属分类 id
  "size": number, // 字节数
  "mime": string, // mime 类型（可选）
  "modifiedAt": string, // ISO8601 时间
  "title": string|null, // 抽取的标题（从 doc/pdf/markdown）
  "previewUrl": string|null,// 可预览的 URL（若支持）
  "downloadUrl": string // 直接下载链接
  }

RESTful API 设计（自顶向下）

说明：API 路径保持简单并兼容静态部署。建议版本前缀 /api/v1。

1. 获取分类树（用于侧栏）
   GET /api/v1/categories
   Query: - flat (boolean) 可选，是否返回扁平数组（默认返回树结构）
   Response 200:
   {
   "data": Category[] // 如果 tree 模式则 children 字段包含子节点
   }

2. 获取某分类下的文件列表（支持分页与筛选）
   GET /api/v1/categories/:categoryId/files
   Query: - page (number) 默认 1 - perPage (number) 默认 24 - sort (string) 'name'|'modified'|'size' - q (string) 可选，关键字搜索（文件名/标题）
   Response 200:
   {
   "data": FileMeta[],
   "meta": { "page": number, "perPage": number, "total": number }
   }

3. 获取单个文件详情
   GET /api/v1/files/:fileId
   Response 200:
   { "data": FileMeta }

4. 搜索接口（跨分类）
   GET /api/v1/search?q=关键词&category=可选分类 id&page=&perPage=

5. 索引文件（静态）
   GET /index.json
   - 可在构建阶段生成仓库索引为静态文件，前端在启动时或按需拉取，减少 Serverless 调用。

错误响应示例
400 Bad Request
{ "error": "Invalid page parameter" }

    404 Not Found
    { "error": "Category not found" }

实现细节建议（后端）

- 方式 A（推荐初期快速实现）：在 CI 或本地构建时扫描仓库并生成静态 JSON 索引（index.json + categories.json）。前端直接请求这些静态 JSON；Vercel 部署后是静态资源，性能最好且无 Serverless 成本。
- 方式 B（如果需要动态更新）：使用 Node.js + Express 或 Fastify，部署为 Serverless 函数，函数在启动时加载索引（或从持久化存储读取），并暴露上面的 API。

索引生成脚本（伪代码）

- 使用 Node.js 脚本遍历仓库目录（排除 .git, node_modules 等），每当遇到文件则构建 FileMeta（读取 fs.stat），并将文件挂到某分类（基于文件父目录）。对常见文档类型尝试抽取标题（例如 md 的第一行、docx 的标题等，作为可选优化）。

前端架构（组件树）

- App (Router)
  - Layout
    - Header (搜索框、站点名)
    - Sidebar (CategoryTree)
    - Main
      - HomePage (聚合视图)
      - CategoryPage (文件网格 + 分页)
        - FileCard
      - FileDetailPage (预览 + 元数据)
      - SearchResultsPage

关键 UI/交互细节

- 分类层级在侧栏以折叠树展示，点击后右侧显示文件网格。
- 文件卡片显示名称、图标（按后缀）、大小、修改时间、下载按钮与预览（如果支持）。
- 文件详情页使用内嵌 PDF 预览（对于 pdf），对于 docx/其他提供下载或使用第三方在线预览器（可选）。
- 搜索为前端发起 API 请求并展示分页结果。

类型与工具建议

- 前端：React + TypeScript + Vite + React Router + SWR/React Query（可选）+ Tailwind CSS 或 Ant Design。
- 后端/脚本：Node.js (>=18) + TypeScript。若使用 Serverless API，推荐使用 Vercel 的函数或 Fastify （兼容 serverless）
- 测试：Jest + React Testing Library（前端），Vitest 也可用配合 Vite。

打包与部署（Vercel）

- 前端：Vite 构建生成静态文件（npm run build 输出 dist），在 Vercel 项目中设置框架为 Vite（或静态站点），指向 dist。
- 后端：若使用 Serverless API，将 API 文件放入 `api/`（或 `api/v1/...`）目录，Vercel 会自动处理为 Serverless 函数。若选择静态索引方式，只需将生成的 JSON 放在 public/ 下。

目录建议（代码仓库）

web/ # 前端工程
package.json
tsconfig.json
vite.config.ts
src/
main.tsx
App.tsx
pages/
components/
api/ # 前端的 API 客户端封装
public/
index.json # 若使用静态索引

api/ # 可选：serverless 后端（若选择方式 B）
package.json
src/
index.ts # serverless handler

tools/
build-index.js # 索引生成脚本（Node.js）

性能与可扩展性考虑

- 索引作为静态文件（在构建时生成）能大幅减少运行时成本与冷启动问题。
- 若文件量很大，支持分页和后端搜索或全文索引（如使用 Lunr 或 Elasticsearch）。
- 使用 CDN（Vercel 自带）为静态文件加速。

小的安全与隐私注意事项

- 不公开托管包含敏感信息的文件。建议在索引生成阶段过滤或标记敏感目录。

开发/测试计划（最小可行产品 MVP）

1. 编写索引生成脚本，生成 `public/index.json` 与 `public/categories.json`。
2. 初始化 Vite + React + TypeScript 前端，完成主页与分类页的基础渲染，读取 `index.json`。
3. 添加文件详情页与下载链接。
4. 部署到 Vercel（作为静态站点），验证浏览与文件访问。

测试用例（示例）

- 索引脚本：当目录包含若干文件时，输出总文件数应匹配；检查随机文件的 path/size/modifiedAt 字段是否正确。
- 前端：在侧栏点击某分类，主区应展示该分类下的文件列表（数量与 index.json 一致）。

后续增强（建议）

- 增加全文搜索（Lunr / Elastic）。
- 增加标签与手动编辑的元数据（例如给文件添加描述）。
- 支持按学期、课程代码等更细粒度的过滤。
- 后台管理界面，支持上传与编辑元数据（需要鉴权）。

交付产物（本次任务）

- 更新 `设计文档.md`（当前文件）——已完成。
- 下一步待办：创建项目脚手架与索引生成脚本（在 todo 列表中）。

验证 & 质量门（Quality Gates）

- 在实现阶段会确保：TypeScript 编译通过（tsc），Vite 项目能成功构建（npm run build），并在本地打开静态 dist 文件夹能正确加载 index.json 并渲染页面。

完成状态

- 本文档（`设计文档.md`）已写入：包含自顶向下的 RESTful 设计、数据模型、前端组件与部署流程。

下一步我将：

- 把 todo 列表中当前项标记为已完成（并把下一个“创建后端脚手架”标为 in-progress），然后根据你的选择开始搭建索引脚本或前端脚手架。
